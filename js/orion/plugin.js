/*******************************************************************************
 * @license
 * Copyright (c) 2011, 2012 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials are made 
 * available under the terms of the Eclipse Public License v1.0 
 * (http://www.eclipse.org/legal/epl-v10.html), and the Eclipse Distribution 
 * License v1.0 (http://www.eclipse.org/org/documents/edl-v10.html). 
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/

(function(e,t){typeof define=="function"&&define.amd?define(["orion/Deferred"],t):typeof exports=="object"?module.exports=t(require("orion/Deferred")):(e.orion=e.orion||{},e.orion.PluginProvider=t(e.orion.Deferred))})(this,function(e){function t(e,t){this.__objectId=e,this.__methods=t}function n(n){function d(e){s&&(typeof ArrayBuffer=="undefined"&&(e=JSON.stringify(e)),s===self?s.postMessage(e):s.postMessage(e,"*"))}function m(){var e=[];return Object.keys(p).forEach(function(t){var n=p[t];e.push({serviceId:t,names:n.names,methods:n.methods,properties:n.properties})}),{headers:r||{},services:e}}function g(e,t){if(t&&t instanceof XMLHttpRequest){var n,r;try{n=t.status,r=t.statusText}catch(i){n=0,r=""}return{status:n||0,statusText:r}}return t}function y(e){var t=e?JSON.parse(JSON.stringify(e,g)):e;return e instanceof Error&&(t.__isError=!0,t.message=t.message||e.message,t.name=t.name||e.name),t}function b(n){if(!s)return(new e).reject(new Error("plugin not connected"));n.id=String(u++);var r=new e;c[n.id]=r,r.then(null,function(e){i&&e instanceof Error&&e.name==="Cancel"&&v({requestId:n.id,method:"cancel",params:e.message?[e.message]:[]})});var o=Object.prototype.toString;return n.params.forEach(function(e,i){if(o.call(e)==="[object Object]"&&!(e instanceof t)){var s,u;for(s in e)o.call(e[s])==="[object Function]"&&(u=u||[],u.push(s));if(u){var f=a++;h[f]=e;var l=function(){delete h[f]};r.then(l,l),n.params[i]=new t(f,u)}}}),v(n),r.promise}function w(e,t){e||e===0?v({id:e,result:null,error:t}):console.log(t)}function E(e,t,n,r){r.forEach(function(e,t){if(e&&typeof e.__objectId!="undefined"){var n={};e.__methods.forEach(function(t){n[t]=function(){return b({objectId:e.__objectId,method:t,params:Array.prototype.slice.call(arguments)})}}),r[t]=n}});var i=typeof e===undefined?null:{id:e,result:null,error:null};try{var s=n.apply(t,r);if(!i)return;s&&typeof s.then=="function"?(l[e]=s,s.then(function(t){delete l[e],i.result=t,v(i)},function(t){l[e]&&(delete l[e],i.error=y(t),v(i))},function(){v({responseId:e,method:"progress",params:Array.prototype.slice.call(arguments)})})):(i.result=s,v(i))}catch(o){i&&(i.error=y(o),v(i))}}function S(e){if(e.source!==s)return;var t=typeof e.data!="string"?e.data:JSON.parse(e.data);try{if(t.method){var n=t.method,r=t.params||[];if("serviceId"in t){var i=p[t.serviceId];i||w(t.id,"service not found"),i=i.implementation,n in i?E(t.id,i,i[n],r):w(t.id,"method not found")}else if("objectId"in t){var o=h[t.objectId];o||w(t.id,"object not found"),!n in o?E(t.id,o,o[n],r):w(t.id,"method not found")}else if("requestId"in t){var u=l[t.requestId];u&&n==="cancel"&&u.cancel&&u.cancel.apply(u,r)}else{if(!("responseId"in t))throw new Error("Bad method: "+t.method);var a=c[t.responseId];a&&n==="progress"&&a.progress&&a.progress.apply(a,r)}}else{var f=c[String(t.id)];delete c[String(t.id)],t.error?f.reject(t.error):f.resolve(t.result)}}catch(d){console.log("Plugin._messageHandler "+d)}}var r=n,i=!1,s=null,o=[],u=0,a=0,f=0,l={},c={},h={},p={},v=d;this.updateHeaders=function(e){if(i)throw new Error("Cannot update headers. Plugin Provider is connected");r=e},this.registerService=function(e,t,n){if(i)throw new Error("Cannot register service. Plugin Provider is connected");typeof e=="string"?e=[e]:Array.isArray(e)||(e=[]);var r=null,s=[];for(r in t)typeof t[r]=="function"&&s.push(r);p[f++]={names:e,methods:s,implementation:t,properties:n||{},listeners:{}}},this.registerServiceProvider=this.registerService,this.connect=function(e,t){if(i){e&&e();return}if(typeof window=="undefined")s=self;else if(window!==window.parent)s=window.parent;else{if(window.opener===null){t&&t("No valid plugin target");return}s=window.opener}addEventListener("message",S,!1);var n={method:"plugin",params:[m()]};d(n),i=!0,e&&e()},this.disconnect=function(){i&&(removeEventListener("message",S),s=null,i=!1)}}return n});