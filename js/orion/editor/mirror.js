/*******************************************************************************
 * @license
 * Copyright (c) 2011, 2013 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials are made 
 * available under the terms of the Eclipse Public License v1.0 
 * (http://www.eclipse.org/legal/epl-v10.html), and the Eclipse Distribution 
 * License v1.0 (http://www.eclipse.org/org/documents/edl-v10.html). 
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/

define("orion/editor/mirror",["i18n!orion/editor/nls/messages","orion/editor/eventTarget","orion/editor/annotations"],function(e,t,n){function i(e){this.string=e,this.pos=0,this.tokenStart=0}function s(e,t){return{token:function(e,t){return e.skipToEnd()}}}function o(e){this._modes={},this.mimeModes={},this.options={},this.StringStream=i,this.defineMode("null",s),this.defineMIME("text/plain","null")}function u(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}function a(e,t,n){n=n||{},this.model=e,this.codeMirror=t,this.isWhitespaceVisible=typeof n.whitespacesVisible=="undefined"?!1:n.whitespacesVisible,this.mode=null,this.isModeLoaded=!1,this.lines=[],this.dirtyLines=[],this.startLine=Number.MAX_VALUE,this.endLine=-1,this.timer=null,this.initialize(e)}function m(e,t,n){this.init(e,t,n)}var r=4;i.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos===0},peek:function(){return this.string[this.pos]},next:function(){return this.string[this.pos++]},eat:function(e){var t=this.string[this.pos],n=typeof t=="string"&&(t===e||e.test&&e.test(t)||typeof e=="function"&&e(t));return n?this.string[this.pos++]:undefined},eatWhile:function(e){var t=!1;while(this.eat(e)!==undefined)t=!0;return t},eatSpace:function(){return this.eatWhile(/\s/)},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var t=this.string.indexOf(e,this.pos);return t!==-1?(this.pos=t,!0):!1},match:function(e,t,n){t=t===!0||typeof t=="undefined";if(typeof e=="string"){var r=n?this.string.toLowerCase():this.string;e=n?e.toLowerCase():e;var i=r.indexOf(e,this.pos);return i!==-1&&t&&(this.pos=i+e.length),i!==-1}var s=this.string.substring(this.pos).match(e);return s&&t&&typeof s[0]=="string"&&(this.pos+=s.index+s[0].length),s},backUp:function(e){this.pos-=e},column:function(){var e=0,t=0;while(t<this.tokenStart)e+=this.string[t++]==="	"?r:1;return e},indentation:function(){var e=this.string.search(/\S/),t=0,n=0;while(n<e)t+=this.string[n++]==="	"?r:1;return t},current:function(){return this.string.substring(this.tokenStart,this.pos)},advance:function(){this.tokenStart=this.pos}},o.prototype={options:{},setOption:function(e,t){this.options[e]=t},getOption:function(e){return this.options[e]},copyState:function(e,t){if(typeof e.copyState=="function")return e.copyState(t);var n={};for(var r in t){var i=t[r];n[r]=i instanceof Array?i.slice():i}return n},startState:function(e,t){return e.startState(t)},defineMode:function(e,t){this._modes[e]=t},defineMIME:function(e,t){this.mimeModes[e]=t},getMode:function(e,t){var n={},r;return typeof t=="string"&&this.mimeModes[t]&&(t=this.mimeModes[t]),typeof t=="object"&&(n=t,r=this._modes[t.name]),r=r||this._modes[t],typeof r!="function"?(typeof console!="undefined"&&console&&console.log("Mode not found: "+t),this.getMode(e,"null")):r(e,n)},listModes:function(){return u(this._modes)},listMIMEs:function(){return u(this.mimeModes)},_getModeName:function(e){var t=this.mimeModes[e];return typeof t=="object"&&(t=t.name),t}};var f="token_tab",l="token_space",c=500,h=50,p=30,d=3,v=40;a.prototype={initialize:function(e){var t=this;this.listener={onModelChanging:function(e){t._onModelChanging(e)},onModelChanged:function(e){t._onModelChanged(e)},onDestroy:function(e){t._onDestroy(e)}},this.model.addEventListener("Changing",this.listener.onModelChanging),this.model.addEventListener("Changed",this.listener.onModelChanged),this.model.addEventListener("Destroy",this.listener.onDestroy)},destroy:function(){this.model&&(this.model.removeEventListener("Changing",this.listener.onModelChanging),this.model.removeEventListener("Changed",this.listener.onModelChanged),this.model.removeEventListener("Destroy",this.listener.onDestroy)),this.model=null,this.codeMirror=null,this.mode=null,this.lines=null,this.dirtyLines=null,clearTimeout(this.timer),this.timer=null},_onModelChanging:function(e){this.startLine=this.model.getLineAtOffset(e.start)},_onModelChanged:function(e){this._dbgEvent(e);var t=this.startLine;(e.removedLineCount||e.addedLineCount)&&Array.prototype.splice.apply(this.lines,[t+1,e.removedLineCount].concat(this._newLines(e.addedLineCount)));if(!this.mode)return;var n=Math.max(e.addedLineCount,e.removedLineCount),r=t+Math.min(n,c);this.highlight(t,r),this.highlightLater(r+1)},_onDestroy:function(e){this.destroy()},setViewportIndex:function(e){this.viewportIndex=e},_dbgEvent:function(e){},_dbgStyle:function(){},_newLines:function(e,t){typeof t=="undefined"&&(t=0);var n=[];for(var r=0;r<e;r++)n.push({style:null,eolState:null});return n},setMode:function(e,t){if(!e)return;this.mode=this.codeMirror.getMode(this.codeMirror.options,e),this.lines=this._newLines(this.model.getLineCount()),t&&this.highlight()},highlight:function(e,t,n){if(!this.mode)return;var r=this.model.getLineCount();e=typeof e=="undefined"?0:e,t=typeof t=="undefined"?r-1:Math.min(t,r-1);var i=this.mode,s=this.getState(e);for(var o=e;o<=t;o++){var u=this.lines[o];this.highlightLine(o,u,s),u.eolState=this.codeMirror.copyState(i,s)}this._expandRange(e,t),n||this.onHighlightDone()},highlightLater:function(e){this.dirtyLines.push(e);var t=this;this.timer=setTimeout(function(){t._highlightJob()},h)},_highlightJob:function(){var e=+(new Date)+p,t=this.mode.compareStates,n=this.model.getLineCount();while(this.dirtyLines.length){var r=this.viewportIndex,i=this.lines[r],s;i&&!i.eolState?s=r:s=this.dirtyLines.pop();if(s>=n)break;this._expandRange(s,s);var o=this._getResumeLineIndex(s),u=o+1,a=o>=0&&this.lines[o].eolState;a=a?this.codeMirror.copyState(this.mode,a):this.mode.startState();var f=0;for(var l=u;l<n;l++){var c=this.lines[l],h=c.eolState,v=this.highlightLine(l,c,a);c.eolState=this.codeMirror.copyState(this.mode,a),v&&this._expandRange(u,l+1);var m=t&&h&&t(h,c.eolState),g=!t&&!v&&f++>d;if(m||g)break;if(!h||v)f=0;var y=l<n||this.dirtyLines.length,b=+(new Date)>e&&y;if(b){this.highlightLater(l+1),this.onHighlightDone();return}}}this.onHighlightDone()},onHighlightDone:function(){this.startLine!==Number.MAX_VALUE&&this.endLine!==-1&&this.dispatchEvent({type:"Highlight",start:this.startLine,end:this.endLine}),this.startLine=Number.MAX_VALUE,this.endLine=-1},_getResumeLineIndex:function(e){var t=this.lines;for(var n=e-1;n>=0;n--)if(t[n].eolState||e-n>v)return n;return-1},getState:function(e){var t=this.mode,n=this.lines,r,i;for(r=e-1;r>=0;r--){i=n[r];if(i.eolState||e-r>v)break}var s=r>=0&&n[r].eolState;if(s){s=this.codeMirror.copyState(t,s),r=Math.max(0,r);for(var o=r;o<e-1;o++)i=n[o],this.highlightLine(o,i,s),i.eolState=this.codeMirror.copyState(t,s);return s}return t.startState()},highlightLine:function(e,t,n){if(!this.mode)return;var r=this.model;r.getLineStart(e)===r.getLineEnd(e)&&this.mode.blankLine&&this.mode.blankLine(n);var s=t.style||[],o=r.getLine(e),u=new i(o),a=!t.style,f=[],l;for(var c=0;!u.eol();c++){var h=this.mode.token(u,n)||null,p=u.current();l=this._whitespaceStyle(h,p,u.tokenStart),l;var d=[u.tokenStart,u.pos,h],v=s[c];f.push(d),a=a||!v||v[0]!==d[0]||v[1]!==d[1]||v[2]!==d[2],u.advance()}return a=a||f.length!==s.length,a&&(t.style=f.length?f:null),a},_whitespaceStyle:function(e,t,n){if(!e&&this.isWhitespaceVisible&&/\s+/.test(t)){var r=[],i,s;for(var o=0;o<t.length;o++){var u=t[o];u!==s&&(s&&r.push([n+i,n+o,s==="	"?f:l]),i=o,s=u)}return r.push([n+i,n+o,s==="	"?f:l]),r}return null},_expandRange:function(e,t){this.startLine=Math.min(this.startLine,e),this.endLine=Math.max(this.endLine,t)},toStyleRangesAndErrors:function(e,t){function n(e){return e?e===f||e===l?e:"cm-"+e:null}var r=e.style;if(!r)return null;var i=[],s=[],o=typeof t=="undefined"?0:this.model.getLineStart(t);for(var u=0;u<r.length;u++){var a=r[u],c=n(a[2]);if(!c)continue;var h={start:o+a[0],end:o+a[1],style:{styleClass:c}};i.push(h),c==="cm-error"&&s.push(h)}return[i,s]},getLineStyle:function(e){return this.lines[e]},getLineStyles:function(){return this.lines}},t.EventTarget.addMixin(a.prototype);var g=20,y="orion.annotation.highlightError";return n.AnnotationType.registerType(y,{title:e.syntaxError,html:"<div class='annotationHTML error'></div>",rangeStyle:{styleClass:"annotationRange error"}}),m.prototype={init:function(e,t,n){this.textView=e,this.annotationModel=n,this.modeApplier=new a(e.getModel(),t);var r=this;this.listener={onLineStyle:function(e){r.onLineStyle(e)},onDestroy:function(e){r.onDestroy(e)},onHighlight:function(e){r.onHighlight(e)}},e.addEventListener("LineStyle",this.listener.onLineStyle),e.addEventListener("Destroy",this.listener.onDestroy),this.modeApplier.addEventListener("Highlight",this.listener.onHighlight)},destroy:function(){this.modeApplier&&(this.modeApplier.removeEventListener("Highlight",this.listener.onHighlight),this.modeApplier.destroy()),this.annotationModel,this.textView&&(this.textView.removeEventListener("LineStyle",this.listener.onLineStyle),this.textView.removeEventListener("Destroy",this.listener.onDestroy)),this.textView=null,this.annotationModel=null,this.modeApplier=null,this.listener=null},setMode:function(e){this.modeApplier.setMode(e)},onLineStyle:function(e){var t=e.lineIndex,r=this.modeApplier,i=r.getLineStyle(t);if(!i||!i.eolState){var s=this.textView.getModel().getLineCount();r.highlight(t,Math.min(t+g,s-1),!0),i=r.getLineStyle(t)}var o=this.textView.getModel();if(i){var u=r.toStyleRangesAndErrors(i,t);if(u){e.ranges=u[0];var a=this.annotationModel;if(a){var f=[],l=[],c=u[1];if(c)for(var h=0;h<c.length;h++){var p=c[h];p.style.styleClass==="cm-error"&&l.push(n.AnnotationType.createAnnotation(y,p.start,p.end))}var d=a.getAnnotations(o.getLineStart(t),o.getLineEnd(t));while(d.hasNext()){var v=d.next();v.type===y&&f.push(v)}a.replaceAnnotations(f,l)}}}},onHighlight:function(e){var t=e.start,n=e.end;this.textView.redrawLines(t,n)},onDestroy:function(e){this.destroy()}},{Mirror:o,ModeApplier:a,CodeMirrorStyler:m}});