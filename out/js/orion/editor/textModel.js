/*******************************************************************************
 * @license
 * Copyright (c) 2010, 2012 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials are made 
 * available under the terms of the Eclipse Public License v1.0 
 * (http://www.eclipse.org/legal/epl-v10.html), and the Eclipse Distribution 
 * License v1.0 (http://www.eclipse.org/org/documents/edl-v10.html). 
 * 
 * Contributors: 
 *		Felipe Heidrich (IBM Corporation) - initial API and implementation
 *		Silenio Quarti (IBM Corporation) - initial API and implementation
 ******************************************************************************/

define("orion/editor/textModel",["orion/editor/eventTarget","orion/util"],function(e,t){function n(e,t){this._lastLineIndex=-1,this._text=[""],this._lineOffsets=[0],this.setText(e),this.setLineDelimiter(t)}return n.prototype={find:function(e){this._text.length>1&&(this._text=[this._text.join("")]);var t=e.string,n=e.regex,r=t,i=e.caseInsensitive;!n&&t&&(r=t.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g,"\\$&"),i&&(r=r.replace(/[iI\u0130\u0131]/g,"[Iiİı]")));var s=null,o;if(r){var u=e.reverse,a=e.wrap,f=e.wholeWord,l=e.start||0,c=e.end,h=c!==null&&c!==undefined,p="";p.indexOf("g")===-1&&(p+="g"),i&&p.indexOf("i")===-1&&(p+="i"),f&&(r="\\b"+r+"\\b");var d=this._text[0],v,m,g=0;if(h){var y=l<c?l:c,b=l<c?c:l;d=d.substring(y,b),g=y}var w=new RegExp(r,p);u?o=function(){var e=null;w.lastIndex=0;for(;;){m=w.lastIndex,v=w.exec(d);if(m===w.lastIndex)return null;if(!v)break;if(v.index+g<l)e={start:v.index+g,end:w.lastIndex+g};else{if(!a||e)break;l=d.length+g,e={start:v.index+g,end:w.lastIndex+g}}}return e&&(l=e.start),e}:(h||(w.lastIndex=l),o=function(){for(;;){m=w.lastIndex,v=w.exec(d);if(m===w.lastIndex)return null;if(v)return{start:v.index+g,end:w.lastIndex+g};if(m!==0&&a)continue;break}return null}),s=o()}return{next:function(){var e=s;return e&&(s=o()),e},hasNext:function(){return s!==null}}},getCharCount:function(){var e=0;for(var t=0;t<this._text.length;t++)e+=this._text[t].length;return e},getLine:function(e,t){var n=this.getLineCount();if(0<=e&&e<n){var r=this._lineOffsets[e];if(e+1<n){var i=this.getText(r,this._lineOffsets[e+1]);if(t)return i;var s=i.length,o;while((o=i.charCodeAt(s-1))===10||o===13)s--;return i.substring(0,s)}return this.getText(r)}return null},getLineAtOffset:function(e){var t=this.getCharCount();if(0<=e&&e<=t){var n=this.getLineCount();if(e===t)return n-1;var r,i,s=this._lastLineIndex;if(0<=s&&s<n){r=this._lineOffsets[s],i=s+1<n?this._lineOffsets[s+1]:t;if(r<=e&&e<i)return s}var o=n,u=-1;while(o-u>1){s=Math.floor((o+u)/2),r=this._lineOffsets[s],i=s+1<n?this._lineOffsets[s+1]:t;if(e<=r)o=s;else{if(e<i){o=s;break}u=s}}return this._lastLineIndex=o,o}return-1},getLineCount:function(){return this._lineOffsets.length},getLineDelimiter:function(){return this._lineDelimiter},getLineEnd:function(e,t){var n=this.getLineCount();if(0<=e&&e<n){if(e+1<n){var r=this._lineOffsets[e+1];if(t)return r;var i=this.getText(Math.max(this._lineOffsets[e],r-2),r),s=i.length,o;while((o=i.charCodeAt(s-1))===10||o===13)s--;return r-(i.length-s)}return this.getCharCount()}return-1},getLineStart:function(e){return 0<=e&&e<this.getLineCount()?this._lineOffsets[e]:-1},getText:function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.getCharCount());if(e===t)return"";var n=0,r=0,i;while(r<this._text.length){i=this._text[r].length;if(e<=n+i)break;n+=i,r++}var s=n,o=r;while(r<this._text.length){i=this._text[r].length;if(t<=n+i)break;n+=i,r++}var u=n,a=r;if(o===a)return this._text[o].substring(e-s,t-u);var f=this._text[o].substring(e-s),l=this._text[a].substring(0,t-u);return f+this._text.slice(o+1,a).join("")+l},onChanging:function(e){return this.dispatchEvent(e)},onChanged:function(e){return this.dispatchEvent(e)},setLineDelimiter:function(e,n){e==="auto"&&(e=undefined,this.getLineCount()>1&&(e=this.getText(this.getLineEnd(0),this.getLineEnd(0,!0)))),this._lineDelimiter=e?e:t.platformDelimiter;if(n){var r=this.getLineCount();if(r>1){var i=new Array(r);for(var s=0;s<r;s++)i[s]=this.getLine(s);this.setText(i.join(this._lineDelimiter))}}},setText:function(e,t,n){e===undefined&&(e=""),t===undefined&&(t=0),n===undefined&&(n=this.getCharCount());if(t===n&&e==="")return;var r=this.getLineAtOffset(t),i=this.getLineAtOffset(n),s=t,o=n-t,u=i-r,a=e.length,f=0,l=this.getLineCount(),c=0,h=0,p=0,d=[];for(;;){c!==-1&&c<=p&&(c=e.indexOf("\r",p)),h!==-1&&h<=p&&(h=e.indexOf("\n",p));if(h===-1&&c===-1)break;c!==-1&&h!==-1?c+1===h?p=h+1:p=(c<h?c:h)+1:c!==-1?p=c+1:p=h+1,d.push(t+p),f++}var v={type:"Changing",text:e,start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanging(v);if(d.length===0){var m=this.getLineStart(r),g;i+1<l?g=this.getLineStart(i+1):g=this.getCharCount(),t!==m&&(e=this.getText(m,t)+e,t=m),n!==g&&(e+=this.getText(n,g),n=g)}var y=a-o;for(var b=r+u+1;b<l;b++)this._lineOffsets[b]+=y;var w=5e4,E=w,S;if(d.length<E)S=[r+1,u].concat(d),Array.prototype.splice.apply(this._lineOffsets,S);else{p=r+1,this._lineOffsets.splice(p,u);for(var x=0;x<d.length;x+=E)S=[p,0].concat(d.slice(x,Math.min(d.length,x+E))),Array.prototype.splice.apply(this._lineOffsets,S),p+=E}var T=0,N=0,C;while(N<this._text.length){C=this._text[N].length;if(t<=T+C)break;T+=C,N++}var k=T,L=N;while(N<this._text.length){C=this._text[N].length;if(n<=T+C)break;T+=C,N++}var A=T,O=N,M=this._text[L],_=this._text[O],D=M.substring(0,t-k),P=_.substring(n-A),H=[L,O-L+1];D&&H.push(D),e&&H.push(e),P&&H.push(P),Array.prototype.splice.apply(this._text,H),this._text.length===0&&(this._text=[""]);var B={type:"Changed",start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanged(B)}},e.EventTarget.addMixin(n.prototype),{TextModel:n}});