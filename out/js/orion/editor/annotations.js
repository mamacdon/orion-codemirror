/*******************************************************************************
 * @license
 * Copyright (c) 2010, 2012 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials are made 
 * available under the terms of the Eclipse Public License v1.0 
 * (http://www.eclipse.org/legal/epl-v10.html), and the Eclipse Distribution 
 * License v1.0 (http://www.eclipse.org/org/documents/edl-v10.html). 
 * 
 * Contributors: 
 *		Felipe Heidrich (IBM Corporation) - initial API and implementation
 *		Silenio Quarti (IBM Corporation) - initial API and implementation
 ******************************************************************************/

define("orion/editor/annotations",["i18n!orion/editor/nls/messages","orion/editor/eventTarget"],function(e,t){function n(e,t,n){this.start=e,this.end=t,this._projectionModel=n,this.html=this._expandedHTML,this.style=this._expandedStyle,this.expanded=!0}function r(){}function s(t,n){var i=t.lastIndexOf("."),s=t.substring(i+1),o={title:e[s],style:{styleClass:"annotation "+s},html:"<div class='annotationHTML "+s+"'></div>",overviewStyle:{styleClass:"annotationOverview "+s}};n?o.lineStyle={styleClass:"annotationLine "+s}:o.rangeStyle={styleClass:"annotationRange "+s},r.registerType(t,o)}function o(){}function u(e){this._annotations=[];var t=this;this._listener={onChanged:function(e){t._onChanged(e)}},this.setTextModel(e)}function a(e,t){this._view=e,this._annotationModel=t;var n=this;this._listener={onDestroy:function(e){n._onDestroy(e)},onLineStyle:function(e){n._onLineStyle(e)},onChanged:function(e){n._onAnnotationModelChanged(e)}},e.addEventListener("Destroy",this._listener.onDestroy),e.addEventListener("postLineStyle",this._listener.onLineStyle),t.addEventListener("Changed",this._listener.onChanged)}n.prototype={_expandedHTML:"<div class='annotationHTML expanded'></div>",_expandedStyle:{styleClass:"annotation expanded"},_collapsedHTML:"<div class='annotationHTML collapsed'></div>",_collapsedStyle:{styleClass:"annotation collapsed"},collapse:function(){if(!this.expanded)return;this.expanded=!1,this.html=this._collapsedHTML,this.style=this._collapsedStyle;var e=this._projectionModel,t=e.getBaseModel();this._projection={start:t.getLineStart(t.getLineAtOffset(this.start)+1),end:t.getLineEnd(t.getLineAtOffset(this.end),!0)},e.addProjection(this._projection)},expand:function(){if(this.expanded)return;this.expanded=!0,this.html=this._expandedHTML,this.style=this._expandedStyle,this._projectionModel.removeProjection(this._projection)}},r.ANNOTATION_ERROR="orion.annotation.error",r.ANNOTATION_WARNING="orion.annotation.warning",r.ANNOTATION_TASK="orion.annotation.task",r.ANNOTATION_BREAKPOINT="orion.annotation.breakpoint",r.ANNOTATION_BOOKMARK="orion.annotation.bookmark",r.ANNOTATION_FOLDING="orion.annotation.folding",r.ANNOTATION_CURRENT_BRACKET="orion.annotation.currentBracket",r.ANNOTATION_MATCHING_BRACKET="orion.annotation.matchingBracket",r.ANNOTATION_CURRENT_LINE="orion.annotation.currentLine",r.ANNOTATION_CURRENT_SEARCH="orion.annotation.currentSearch",r.ANNOTATION_MATCHING_SEARCH="orion.annotation.matchingSearch",r.ANNOTATION_READ_OCCURRENCE="orion.annotation.readOccurrence",r.ANNOTATION_WRITE_OCCURRENCE="orion.annotation.writeOccurrence",r.ANNOTATION_SELECTED_LINKED_GROUP="orion.annotation.selectedLinkedGroup",r.ANNOTATION_CURRENT_LINKED_GROUP="orion.annotation.currentLinkedGroup",r.ANNOTATION_LINKED_GROUP="orion.annotation.linkedGroup",r.ANNOTATION_BLAME="orion.annotation.blame",r.ANNOTATION_CURRENT_BLAME="orion.annotation.currentBlame";var i={};return r.registerType=function(e,t){var n=t;return typeof n!="function"&&(n=function(e,t,n){this.start=e,this.end=t,n!==undefined&&(this.title=n)},n.prototype=t),n.prototype.type=e,i[e]=n,e},r.createAnnotation=function(e,t,n,r){return new(this.getType(e))(t,n,r)},r.getType=function(e){return i[e]},s(r.ANNOTATION_ERROR),s(r.ANNOTATION_WARNING),s(r.ANNOTATION_TASK),s(r.ANNOTATION_BREAKPOINT),s(r.ANNOTATION_BOOKMARK),s(r.ANNOTATION_CURRENT_BRACKET),s(r.ANNOTATION_MATCHING_BRACKET),s(r.ANNOTATION_CURRENT_SEARCH),s(r.ANNOTATION_MATCHING_SEARCH),s(r.ANNOTATION_READ_OCCURRENCE),s(r.ANNOTATION_WRITE_OCCURRENCE),s(r.ANNOTATION_SELECTED_LINKED_GROUP),s(r.ANNOTATION_CURRENT_LINKED_GROUP),s(r.ANNOTATION_LINKED_GROUP),s(r.ANNOTATION_CURRENT_LINE,!0),s(r.ANNOTATION_BLAME,!0),s(r.ANNOTATION_CURRENT_BLAME,!0),r.registerType(r.ANNOTATION_FOLDING,n),o.addMixin=function(e){var t=o.prototype;for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},o.prototype={addAnnotationType:function(e){this._annotationTypes||(this._annotationTypes=[]),this._annotationTypes.push(e)},getAnnotationTypePriority:function(e){if(this._annotationTypes)for(var t=0;t<this._annotationTypes.length;t++)if(this._annotationTypes[t]===e)return t+1;return 0},getAnnotationsByType:function(e,t,n){var r=e.getAnnotations(t,n),i,s=[];while(r.hasNext()){i=r.next();var o=this.getAnnotationTypePriority(i.type);if(o===0)continue;s.push(i)}var u=this;return s.sort(function(e,t){return u.getAnnotationTypePriority(e.type)-u.getAnnotationTypePriority(t.type)}),s},isAnnotationTypeVisible:function(e){return this.getAnnotationTypePriority(e)!==0},removeAnnotationType:function(e){if(!this._annotationTypes)return;for(var t=0;t<this._annotationTypes.length;t++)if(this._annotationTypes[t]===e){this._annotationTypes.splice(t,1);break}}},u.prototype={addAnnotation:function(e){if(!e)return;var t=this._annotations,n=this._binarySearch(t,e.start);t.splice(n,0,e);var r={type:"Changed",added:[e],removed:[],changed:[]};this.onChanged(r)},getTextModel:function(){return this._model},getAnnotations:function(e,t){var n=this._annotations,r,i=0,s=function(){while(i<n.length){var r=n[i++];if(e===r.start||(e>r.start?e<r.end:r.start<t))return r;if(r.start>=t)break}return null};return r=s(),{next:function(){var e=r;return e&&(r=s()),e},hasNext:function(){return r!==null}}},modifyAnnotation:function(e){if(!e)return;var t=this._getAnnotationIndex(e);if(t<0)return;var n={type:"Changed",added:[],removed:[],changed:[e]};this.onChanged(n)},onChanged:function(e){return this.dispatchEvent(e)},removeAnnotations:function(e){var t=this._annotations,n,r;if(e){n=[];for(r=t.length-1;r>=0;r--){var i=t[r];i.type===e&&(t.splice(r,1),n.splice(0,0,i))}}else n=t,t=[];var s={type:"Changed",removed:n,added:[],changed:[]};this.onChanged(s)},removeAnnotation:function(e){if(!e)return;var t=this._getAnnotationIndex(e);if(t<0)return;var n={type:"Changed",removed:this._annotations.splice(t,1),added:[],changed:[]};this.onChanged(n)},replaceAnnotations:function(e,t){var n=this._annotations,r,i,s,o=[];if(e)for(r=e.length-1;r>=0;r--){s=e[r],i=this._getAnnotationIndex(s);if(i<0)continue;n.splice(i,1),o.splice(0,0,s)}t||(t=[]);for(r=0;r<t.length;r++)s=t[r],i=this._binarySearch(n,s.start),n.splice(i,0,s);var u={type:"Changed",removed:o,added:t,changed:[]};this.onChanged(u)},setTextModel:function(e){this._model&&this._model.removeEventListener("Changed",this._listener.onChanged),this._model=e,this._model&&this._model.addEventListener("Changed",this._listener.onChanged)},_binarySearch:function(e,t){var n=e.length,r=-1,i;while(n-r>1)i=Math.floor((n+r)/2),t<=e[i].start?n=i:r=i;return n},_getAnnotationIndex:function(e){var t=this._annotations,n=this._binarySearch(t,e.start);while(n<t.length&&t[n].start===e.start){if(t[n]===e)return n;n++}return-1},_onChanged:function(e){var t=e.start,n=e.addedCharCount,r=e.removedCharCount,i=this._annotations,s=t+r,o=0;if(!(0<=o&&o<i.length))return;var u={type:"Changed",added:[],removed:[],changed:[],textModelChangedEvent:e},a=n-r,f;for(f=o;f<i.length;f++){var l=i[f];l.start>=s?(l.start+=a,l.end+=a,u.changed.push(l)):l.end<=t||(l.start<t&&s<l.end?(l.end+=a,u.changed.push(l)):(i.splice(f,1),u.removed.push(l),f--))}(u.added.length>0||u.removed.length>0||u.changed.length>0)&&this.onChanged(u)}},t.EventTarget.addMixin(u.prototype),a.prototype={destroy:function(){var e=this._view;e&&(e.removeEventListener("Destroy",this._listener.onDestroy),e.removeEventListener("LineStyle",this._listener.onLineStyle),this.view=null);var t=this._annotationModel;t&&(t.removeEventListener("Changed",this._listener.onChanged),t=null)},_mergeStyle:function(e,t){if(t){e||(e={}),e.styleClass&&t.styleClass&&e.styleClass!==t.styleClass?e.styleClass+=" "+t.styleClass:e.styleClass=t.styleClass;var n;t.tagName&&(e.tagName||(e.tagName=t.tagName));if(t.style){e.style||(e.style={});for(n in t.style)e.style[n]||(e.style[n]=t.style[n])}if(t.attributes){e.attributes||(e.attributes={});for(n in t.attributes)e.attributes[n]||(e.attributes[n]=t.attributes[n])}}return e},_mergeStyleRanges:function(e,t){e||(e=[]);var n,r;for(r=0;r<e.length&&t;r++){var i=e[r];if(t.end<=i.start)break;if(t.start>=i.end)continue;n=this._mergeStyle({},i.style),n=this._mergeStyle(n,t.style);var s=[];s.push(r,1),t.start<i.start&&s.push({start:t.start,end:i.start,style:t.style}),t.start>i.start&&s.push({start:i.start,end:t.start,style:i.style}),s.push({start:Math.max(i.start,t.start),end:Math.min(i.end,t.end),style:n}),t.end<i.end&&s.push({start:t.end,end:i.end,style:i.style}),t.end>i.end?t={start:i.end,end:t.end,style:t.style}:t=null,Array.prototype.splice.apply(e,s)}return t&&(n=this._mergeStyle({},t.style),e.splice(r,0,{start:t.start,end:t.end,style:n})),e},_onAnnotationModelChanged:function(e){function i(e){for(var i=0;i<e.length;i++){if(!n.isAnnotationTypeVisible(e[i].type))continue;var s=e[i].start,o=e[i].end;r.getBaseModel&&(s=r.mapOffset(s,!0),o=r.mapOffset(o,!0)),s!==-1&&o!==-1&&t.redrawRange(s,o)}}if(e.textModelChangedEvent)return;var t=this._view;if(!t)return;var n=this,r=t.getModel();i(e.added),i(e.removed),i(e.changed)},_onDestroy:function(e){this.destroy()},_onLineStyle:function(e){var t=this._annotationModel,n=e.textView.getModel(),r=t.getTextModel(),i=e.lineStart,s=e.lineStart+e.lineText.length;r!==n&&(i=n.mapOffset(i),s=n.mapOffset(s));var o=t.getAnnotations(i,s);while(o.hasNext()){var u=o.next();if(!this.isAnnotationTypeVisible(u.type))continue;if(u.rangeStyle){var a=u.start,f=u.end;r!==n&&(a=n.mapOffset(a,!0),f=n.mapOffset(f,!0)),e.ranges=this._mergeStyleRanges(e.ranges,{start:a,end:f,style:u.rangeStyle})}u.lineStyle&&(e.style=this._mergeStyle({},e.style),e.style=this._mergeStyle(e.style,u.lineStyle))}}},o.addMixin(a.prototype),{FoldingAnnotation:n,AnnotationType:r,AnnotationTypeList:o,AnnotationModel:u,AnnotationStyler:a}});